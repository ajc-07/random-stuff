javascript:(function(){console.log('üèì start');function gN(){const h=document.querySelector('td.omnipong h4')||document.querySelector('h4');if(!h)return null;const t=Array.from(h.childNodes).find(n=>n.nodeType===3);const r=t?t.nodeValue:h.textContent;return r.replace(/\s+/g,' ').trim()}function pfg(A,B,w){const d=Math.abs(A-B),i=d<=12?0:d<=37?1:d<=62?2:d<=87?3:d<=112?4:d<=137?5:d<=162?6:d<=187?7:d<=212?8:d<=237?9:10,ex=[8,7,6,5,4,3,2,2,1,1,0],up=[8,10,13,16,20,25,30,35,40,45,50];return w?(A>=B?ex[i]:up[i]):(A>=B?-up[i]:-ex[i])}function comp(cur,gs){console.log('--- Pass 1 (cur='+cur+') ---');let p1=0;gs.forEach((g,i)=>{const pts=pfg(cur,g.rating,g.win);console.log(`Game ${i}: rating=${g.rating}, win=${g.win}, pts=${pts}`);p1+=pts});console.log('Total Pass1 points='+p1);let a,f;if(p1<50){a=cur+p1;f=a;console.log('Pass1<50 ‚Üí adjusted='+a,'Final='+f)}else if(p1<75){a=cur+p1;console.log('50‚â§Pass1<75 ‚Üí adjusted='+a,'--- Pass 2 ---');let p2=0;gs.forEach((g,i)=>{const pts=pfg(a,g.rating,g.win);console.log('Game '+i+': pts2='+pts);p2+=pts});console.log('Total Pass2 points='+p2);f=a+p2;console.log('Final='+f)}else{console.log('Pass1‚â•75 ‚Üí Tier 2');const ws=gs.filter(g=>g.win).map(g=>g.rating),ls=gs.filter(g=>!g.win).map(g=>g.rating);const tmp=Math.floor((cur+p1+(Math.max(...ws)+Math.min(...ls))/2)/2);let p3=0;a=tmp;console.log('Adjusted (tier2)='+a,'--- Pass 3 ---');gs.forEach((g,i)=>{const pts=pfg(a,g.rating,g.win);console.log('Game '+i+': pts3='+pts);p3+=pts});console.log('Total Pass3 points='+p3);f=a+p3;console.log('Final='+f)}return{adjusted:a,final:f}}function parse(){const ts=document.querySelectorAll('table.omnipong'),gs=[];for(const t of ts){let w=null,s=t.previousSibling;while(s&&(s.nodeType!==1&&s.nodeType!==3))s=s.previousSibling;const tx=(s?.textContent||s?.nodeValue||'').toLowerCase();if(tx.includes('wins'))w=true;else if(tx.includes('loss'))w=false;else if(w===null)w=gs.length===0;Array.from(t.querySelectorAll('tr')).slice(1).forEach(r=>{const c=r.querySelectorAll('td'),a=c[0].querySelector('a');const name=a?a.textContent.trim():c[0].textContent.trim();const id=a?new URL(a.href,location.origin).searchParams.get('p'):'';const rating=parseInt(c[2].textContent.trim(),10)||0;gs.push({name,id,rating,win:w})})}console.log('üßæ Parsed games:',gs.map(g=>({name:g.name,id:g.id,rating:g.rating,win:g.win})));return gs}function logPick(raw){try{const u=new URL(raw,location.origin);console.log('üßæ Picked from Sort-by-Rating button:',{href:u.href,t:u.searchParams.get('t'),r:u.searchParams.get('r')});return u.href}catch(e){console.warn('Could not parse picked URL:',raw,e);return raw}}function fetchCR(fullName,pid){const nm=fullName.replace(/\bWins\b.*$/i,'').replace(/\bLoss(?:es)?\b.*$/i,'').trim();return new Promise((res,rej)=>{console.log('Fetch rating for',nm,'(playerId:',pid||'none',')');const btn=[...document.querySelectorAll('input[name="Action"]')].find(i=>i.value==='Sort by Rating');if(!btn)return rej('no-button');const m=(btn.getAttribute('onclick')||'').match(/open_window\('([^']+)'/);if(!m)return rej('bad-link');const href=logPick(m[1].replace(/&amp;/g,'&'));console.log('üîó URL:',href);fetch(href).then(r=>{if(!r.ok)throw r.status;return r.text()}).then(txt=>{const doc=new DOMParser().parseFromString(txt,'text/html');const table=[...doc.querySelectorAll('table.omnipong')].find(t=>[...t.querySelectorAll('th')].some(h=>/Ratings/i.test(h.textContent)));console.log('Rating table found?',!!table);if(!table)return rej('no-table');if(pid){const a=[...table.querySelectorAll('a[href*="p="]')].find(x=>{try{return new URL(x.href,location.origin).searchParams.get('p')===pid}catch{return false}});if(a){const row=a.closest('tr');const seed=parseInt(row.querySelectorAll('td')[3].textContent.trim().split('/')[0],10);console.log('Matched by ID ‚Üí seed:',seed);return Number.isFinite(seed)?res(seed):rej('seed-parse-failed')}console.log('‚ö†Ô∏è No ID match; falling back to name match.')}const [first,...rest]=nm.split(/\s+/);const last=rest.join(' ');let seed=null;for(const r of [...table.querySelectorAll('tr')].slice(1)){const cols=r.querySelectorAll('td');if(cols.length<4)continue;const cell=cols[0].textContent.trim().replace(/^-/,'');const [rLast,rFirst]=cell.split(',').map(s=>s.trim());if(rLast&&rFirst&&rLast.toLowerCase()===last.toLowerCase()&&rFirst.split(/\s+/)[0].toLowerCase()===first.toLowerCase()){seed=parseInt(cols[3].textContent.trim().split('/')[0],10);break}}console.log('Matched by name ‚Üí seed:',seed);return seed==null?rej('not-found'):res(seed)}).catch(e=>{console.error('Fetch error',e);rej(e)})})}const url=new URL(location.href);console.log('üìÑ Page URL:',url.href,'page.t=',url.searchParams.get('t'),'page.p=',url.searchParams.get('p'));const name=gN(),pid=url.searchParams.get('p')||null,gs=parse();console.log('Player:',name,'Games:',gs.length);if(!name){alert('‚ùå Couldn‚Äôt detect your name on this page');return}fetchCR(name,pid).then(cur=>{console.log('üèÖ Current seed:',cur);const uniq={},unk=[];gs.forEach(g=>{if(g.rating===0&&!uniq[g.id]){uniq[g.id]=g;unk.push(g)}});console.log('Unknowns:',unk.map(o=>o.name+'('+o.id+')'));unk.forEach(op=>{const ans=prompt('Opponent '+op.name+' (ID:'+op.id+') has rating=0. Enter estimate:'),e=parseInt(ans,10);if(!isNaN(e))gs.forEach(g=>g.id===op.id&&(g.rating=e))});const r=comp(cur,gs);alert('Player: '+name+'\nCurrent (seed) Rating: '+cur+'\nAdjusted Rating:      '+r.adjusted+'\nNew Rating:           '+r.final+'\n\n(More details in console)')}).catch(err=>{console.error('‚ùå Lookup failed:',err);alert('Lookup failed: '+err)})})();
